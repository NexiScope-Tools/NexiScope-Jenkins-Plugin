name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: ðŸ·ï¸ Get version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“‹ Version: $VERSION"

    - name: ðŸ”¨ Build plugin
      run: mvn clean package -DskipTests

    - name: ðŸ“¦ Prepare release artifacts
      run: |
        cd target
        VERSION=${{ steps.version.outputs.version }}
        cp nexiscope-integration.hpi nexiscope-integration-${VERSION}.hpi
        cp nexiscope-integration.jar nexiscope-integration-${VERSION}.jar

        # Create checksums
        sha256sum nexiscope-integration-${VERSION}.hpi > nexiscope-integration-${VERSION}.hpi.sha256
        sha256sum nexiscope-integration-${VERSION}.jar > nexiscope-integration-${VERSION}.jar.sha256

        echo "âœ… Release artifacts prepared"
        ls -lh nexiscope-integration-${VERSION}.*

    - name: ðŸ“ Extract release notes
      id: release_notes
      run: |
        VERSION=${{ steps.version.outputs.version }}

        echo "ðŸ” Extracting release notes for version ${VERSION}"
        echo "ðŸ“„ Checking CHANGELOG.md..."

        if [ ! -f "CHANGELOG.md" ]; then
          echo "âŒ ERROR: CHANGELOG.md not found!"
          exit 1
        fi

        # Show what we're looking for
        echo "ðŸ”Ž Looking for: ## [${VERSION}]"
        grep -n "## \[${VERSION}\]" CHANGELOG.md || echo "âš ï¸  Version header not found in CHANGELOG"

        # Get the section for this version from CHANGELOG
        # Extract from version header to next version header (or end of file)
        NOTES=$(awk "/## \[${VERSION}\]/,/^## \[.*\]/ {
          if (/^## \[${VERSION}\]/) next;
          if (/^## \[.*\]/) exit;
          print
        }" CHANGELOG.md)

        if [ -z "$NOTES" ]; then
          echo "âš ï¸  No release notes found for version ${VERSION}, using fallback"
          NOTES="Release version ${VERSION}

See [CHANGELOG.md](https://github.com/NexiScope-Tools/NexiScope-Jenkins-Plugin/blob/main/CHANGELOG.md) for details."
        else
          echo "âœ… Successfully extracted release notes ($(echo "$NOTES" | wc -l) lines)"
        fi

        # Create release notes with header and footer
        cat > /tmp/release_notes.md << 'EOF'
# NexiScope Jenkins Plugin

Official Jenkins plugin for real-time CI/CD observability with the NexiScope Platform.

---

EOF

        echo "$NOTES" >> /tmp/release_notes.md

        cat >> /tmp/release_notes.md << 'EOF'

        ---

        ## ðŸ“¦ Installation

        ### Via Jenkins UI
        1. Download `nexiscope-integration-VERSION.hpi` from the assets below
        2. Go to **Manage Jenkins** â†’ **Manage Plugins** â†’ **Advanced**
        3. Upload the `.hpi` file under "Upload Plugin"
        4. Restart Jenkins when prompted

        ### Via Jenkins CLI
        ```bash
        java -jar jenkins-cli.jar -s http://your-jenkins-url/ install-plugin nexiscope-integration-VERSION.hpi
        ```

        ## ðŸ“š Documentation

        - ðŸ“– [User Guide](https://github.com/NexiScope-Tools/NexiScope-Jenkins-Plugin/blob/main/docs/USER_GUIDE.md)
        - ðŸ”§ [Developer Guide](https://github.com/NexiScope-Tools/NexiScope-Jenkins-Plugin/blob/main/docs/DEVELOPER_GUIDE.md)
        - ðŸ—ï¸ [Architecture](https://github.com/NexiScope-Tools/NexiScope-Jenkins-Plugin/blob/main/docs/ARCHITECTURE.md)
        - ðŸ“‹ [API Reference](https://github.com/NexiScope-Tools/NexiScope-Jenkins-Plugin/blob/main/docs/API_REFERENCE.md)
        - ðŸ”’ [Security Policy](https://github.com/NexiScope-Tools/NexiScope-Jenkins-Plugin/blob/main/SECURITY.md)

        ## ðŸ” Checksums

        SHA256 checksums are provided for all artifacts. Verify downloads with:
        ```bash
        sha256sum -c nexiscope-integration-VERSION.hpi.sha256
        ```

        ## ðŸ“‹ Requirements

        - **Jenkins**: 2.528.3 or later
        - **Java**: 21 or later
        - **NexiScope Platform**: Active account required

        ## ðŸ†˜ Support

        - ðŸ’¬ [Discussions](https://github.com/NexiScope-Tools/NexiScope-Jenkins-Plugin/discussions)
        - ðŸ› [Report Issues](https://github.com/NexiScope-Tools/NexiScope-Jenkins-Plugin/issues)
        - ðŸ“§ [Email Support](mailto:support@nexiscope.com)
        - ðŸ“š [Documentation](https://docs.nexiscope.com/jenkins-plugin)

        ---

        **Full Changelog**: https://github.com/NexiScope-Tools/NexiScope-Jenkins-Plugin/blob/main/CHANGELOG.md
        EOF

        # Replace VERSION placeholder with actual version
        sed -i "s/VERSION/$VERSION/g" /tmp/release_notes.md

        echo "ðŸ“ Release notes created with full details"

    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: NexiScope Jenkins Plugin v${{ steps.version.outputs.version }}
        body_path: /tmp/release_notes.md
        files: |
          target/nexiscope-integration-${{ steps.version.outputs.version }}.hpi
          target/nexiscope-integration-${{ steps.version.outputs.version }}.jar
          target/nexiscope-integration-${{ steps.version.outputs.version }}.hpi.sha256
          target/nexiscope-integration-${{ steps.version.outputs.version }}.jar.sha256
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: âœ… Release summary
      run: |
        echo "### ðŸš€ Release v${{ steps.version.outputs.version }} Published" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
        echo "- nexiscope-integration-${{ steps.version.outputs.version }}.hpi" >> $GITHUB_STEP_SUMMARY
        echo "- nexiscope-integration-${{ steps.version.outputs.version }}.jar" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Release is now available on GitHub Releases"

