name: Version Bump

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.1.0, 2.0.0)'
        required: true
        type: string
      next_version:
        description: 'Next development version (e.g., 1.2.0-SNAPSHOT)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ‚öôÔ∏è Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: üîç Validate version format
      run: |
        VERSION="${{ github.event.inputs.version }}"
        NEXT_VERSION="${{ github.event.inputs.next_version }}"

        # Validate release version (e.g., 1.0.0)
        if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "‚ùå Invalid version format: $VERSION"
          echo "Expected format: X.Y.Z (e.g., 1.0.0)"
          exit 1
        fi

        # Validate next version ends with -SNAPSHOT
        if ! [[ "$NEXT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-SNAPSHOT$ ]]; then
          echo "‚ùå Invalid next version format: $NEXT_VERSION"
          echo "Expected format: X.Y.Z-SNAPSHOT (e.g., 1.1.0-SNAPSHOT)"
          exit 1
        fi

        echo "‚úÖ Version formats are valid"

    - name: üìù Update POM to release version
      run: |
        VERSION="${{ github.event.inputs.version }}"

        # Update version in pom.xml
        sed -i.bak "s|<version>.*</version>|<version>$VERSION</version>|" pom.xml
        rm pom.xml.bak

        echo "‚úÖ Updated pom.xml to version $VERSION"

    - name: üìù Update CHANGELOG
      run: |
        VERSION="${{ github.event.inputs.version }}"
        DATE=$(date +%Y-%m-%d)

        # Add release date to CHANGELOG if it has [Unreleased]
        if grep -q "\[Unreleased\]" CHANGELOG.md; then
          sed -i.bak "s/\[Unreleased\]/[$VERSION] - $DATE/" CHANGELOG.md
          rm CHANGELOG.md.bak
          echo "‚úÖ Updated CHANGELOG.md with release date"
        else
          echo "‚ÑπÔ∏è  No [Unreleased] section found in CHANGELOG.md"
        fi

    - name: üíæ Commit release version
      run: |
        VERSION="${{ github.event.inputs.version }}"

        git add pom.xml CHANGELOG.md
        git commit -m "chore: release version $VERSION" -m "[skip ci]"

        echo "‚úÖ Committed release version"

    - name: üè∑Ô∏è Create and push tag
      run: |
        VERSION="${{ github.event.inputs.version }}"

        # Create annotated tag
        git tag -a "v$VERSION" -m "Release v$VERSION" -m "See CHANGELOG.md for details."

        # Push commit and tag
        git push origin main
        git push origin "v$VERSION"

        echo "‚úÖ Created and pushed tag v$VERSION"

    - name: üìù Update POM to next development version
      run: |
        NEXT_VERSION="${{ github.event.inputs.next_version }}"

        # Update version in pom.xml
        sed -i.bak "s|<version>.*</version>|<version>$NEXT_VERSION</version>|" pom.xml
        rm pom.xml.bak

        echo "‚úÖ Updated pom.xml to version $NEXT_VERSION"

    - name: üìù Prepare CHANGELOG for next version
      run: |
        NEXT_VERSION="${{ github.event.inputs.next_version }}"

        # Add new [Unreleased] section at the top
        sed -i.bak '0,/^## \[/s//## [Unreleased]\n\n### Added\n\n### Changed\n\n### Fixed\n\n&/' CHANGELOG.md
        rm CHANGELOG.md.bak

        echo "‚úÖ Added [Unreleased] section to CHANGELOG.md"

    - name: üíæ Commit next development version
      run: |
        NEXT_VERSION="${{ github.event.inputs.next_version }}"

        git add pom.xml CHANGELOG.md
        git commit -m "chore: prepare for next development iteration $NEXT_VERSION" -m "[skip ci]"

        git push origin main

        echo "‚úÖ Committed next development version"

    - name: ‚úÖ Summary
      run: |
        VERSION="${{ github.event.inputs.version }}"
        NEXT_VERSION="${{ github.event.inputs.next_version }}"

        echo "### üöÄ Version Bump Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Released Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "**Next Version:** $NEXT_VERSION" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tag:** v$VERSION" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Release workflow will be triggered automatically" >> $GITHUB_STEP_SUMMARY

